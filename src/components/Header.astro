---
import links from "../data/links.json";
import config from "virtual:starlight/user-config";

import LanguageSelect from "@astrojs/starlight/components/LanguageSelect.astro";
import Search from "@astrojs/starlight/components/Search.astro";
import SiteTitle from "@astrojs/starlight/components/SiteTitle.astro";
import SocialIcons from "@astrojs/starlight/components/SocialIcons.astro";
import ThemeSelect from "@astrojs/starlight/components/ThemeSelect.astro";

/**
 * Render the `Search` component if Pagefind is enabled or the default search component has been overridden.
 */
const shouldRenderSearch =
    config.pagefind ||
    config.components.Search !== "@astrojs/starlight/components/Search.astro";
---

<div class="header" x-data="{ open: false }">
    <div class="title-wrapper sl-flex">
        <SiteTitle />
    </div>
    <div class="sl-flex print:hidden">
        {shouldRenderSearch && <Search />}
    </div>
    <div class="right-group sl-flex print:hidden items-center">
        <!-- Hamburger menu button, visible on md and below -->
        <button
            class="md:hidden p-2 rounded focus:outline-none focus:ring"
            @click="open = !open"
            aria-label="Open site links menu"
        >
            <!-- Hamburger icon -->
            <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Site links: hidden on md and below, flex on md+ -->
        <div class="site_links hidden md:flex">
            {
                links.map((link, idx) =>
                    link.sub ? (
                        <div
                            class="site_link relative"
                            x-data={`{ open${idx}: false }`}
                        >
                            <button
                                type="button"
                                class="site_link"
                                @click={`open${idx} = !open${idx}`}
                                aria-haspopup="true"
                            >
                                {link.text}
                            </button>
                            <div
                                class="dropdown-menu absolute left-0 mt-2 w-40 bg-white border rounded shadow-lg z-50"
                                x-show={`open${idx}`}
                                @click.away={`open${idx} = false`}
                                x-transition
                                style="display: none;"
                            >
                                {link.sub.map((sublink) => (
                                    <div class="site_link">
                                        <a
                                            href={sublink.link}
                                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                            tabindex="0"
                                        >
                                            {sublink.text}
                                        </a>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div class="site_link">
                            <a href={link.link}>{link.text}</a>
                        </div>
                    ),
                )
            }
        </div>
        <!-- Dropdown menu for mobile -->
        <div
            class="absolute top-full left-0 w-full bg-white shadow-md z-50 flex flex-col md:hidden"
            x-show="open"
            @click.away="open = false"
            x-transition
        >
            {
                links.map((link) => (
                    <div class="site_link">
                        <a href={link.link}>{link.text}</a>
                    </div>
                ))
            }
        </div>
        <div class="sl-flex social-icons">
            <SocialIcons />
        </div>
        <ThemeSelect />
        <LanguageSelect />
    </div>
</div>

<style>
    @layer starlight.core {
        .header {
            display: flex;
            gap: var(--sl-nav-gap);
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .title-wrapper {
            /* Prevent long titles overflowing and covering the search and menu buttons on narrow viewports. */
            overflow: clip;
            /* Avoid clipping focus ring around link inside title wrapper. */
            padding: 0.25rem;
            margin: -0.25rem;
            min-width: 0;
        }

        .site_links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .site_link a,
        .site_link button {
            color: var(--sl-color-text);
            font-size: var(--sl-font-size-text);
            font-family: var(--sl-font-family);
            font-weight: var(--sl-font-weight-normal);
            text-decoration: none;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .site_link a:hover,
        .site_link button:hover {
            color: var(--sl-color-accent);
            text-decoration: underline;
        }

        .right-group,
        .social-icons {
            gap: 1rem;
            align-items: center;
        }
        .social-icons::after {
            content: "";
            height: 2rem;
            border-inline-end: 1px solid var(--sl-color-gray-5);
        }

        @media (min-width: 50rem) {
            :global(:root[data-has-sidebar]) {
                --__sidebar-pad: calc(2 * var(--sl-nav-pad-x));
            }
            :global(:root:not([data-has-toc])) {
                --__toc-width: 0rem;
            }
            .header {
                --__sidebar-width: max(
                    0rem,
                    var(--sl-content-inline-start, 0rem) - var(--sl-nav-pad-x)
                );
                --__main-column-fr: calc(
                    (
                            100% + var(--__sidebar-pad, 0rem) -
                                var(--__toc-width, var(--sl-sidebar-width)) -
                                (2 * var(--__toc-width, var(--sl-nav-pad-x))) -
                                var(--sl-content-inline-start, 0rem) -
                                var(--sl-content-width)
                        ) / 2
                );
                display: grid;
                grid-template-columns:
        /* 1 (site title): runs up until the main content columnâ€™s left edge or the width of the title, whichever is the largest  */
                    minmax(
                        calc(
                            var(--__sidebar-width) +
                                max(
                                    0rem,
                                    var(--__main-column-fr) - var(--sl-nav-gap)
                                )
                        ),
                        auto
                    )
                    /* 2 (search box): all free space that is available. */
                    1fr
                    /* 3 (right items): use the space that these need. */
                    auto;
                align-content: center;
            }
        }
    }
</style>
